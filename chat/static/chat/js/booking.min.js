var isOnBottom=!1;$(document).ready(()=>{function a(a){return a?.sender?.avatar?`
                <img
                    height="32"
                    width="32"
                    src="${a.sender.avatar}" 
                    class="rounded-circle chat-avatar"
                    alt 
                />
            `:"<div style=\"width:32px; height:32px; min-width: 32px !important; min-height: 32px;\"></div>"}function b(a){return`${("0"+a.getDate()).slice(-2)}.${("0"+(a.getMonth()+1)).slice(-2)}.${a.getFullYear()}, ${("0"+a.getHours()).slice(-2)}:${("0"+a.getMinutes()).slice(-2)}`}function c(c){const d=c.sender?c.is_out?"bg-primary text-white":"bg-secondary text-white":"bg-white text-dark border border-dark",e=c.sender?"":"\u0421\u0438\u0441\u0442\u0435\u043C\u043D\u043E\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435<br>";return`
            <div id="msg${c.id}" class="list-group-item border-0" style="width: fit-content;">
                <div class="d-flex gap-3">
                    `+a(c)+`
                    <div class="d-flex ${d} rounded p-1 px-2" style="font-size: 18px; height: fit-content">${c.text.replaceAll("\r\n","<br>")}</div>
                    <small class="float-end pe-1 align-self-end" style="font-size: 12px;">${e}${b(new Date(c.sent_at))}</small>
                </div>
            </div>  
        `}function d(a){window.lastMessageId=a.id,n.append(c(a))}function e(){return m.val()}function f(){function a(a){m.val(null),d(a.data),$("html, body").animate({scrollTop:$(document).height()})}function b(a){console.log("onError",a),showErrorToast(a.responseJSON.message)}const c=e();if(c){const d=new FormData;d.append("text",c),d.append("booking_id",window.bookingId),$.ajax({type:"POST",url:`/chat/api/send_message_booking/`,data:d,processData:!1,contentType:!1,success:a,error:b})}}// Long polling
function g(){$.ajax({type:"GET",url:`/chat/api/get_new_messages_booking/${window.bookingId}/`}).done(function(a){if(0<a?.data?.length){for(let b of a.data)d(b);isOnBottom&&$("html, body").animate({scrollTop:$(document).height()})}g()}).fail(function(a){0==a.status&&g()})}let h=0,i=62;const j=$("#bookingData"),k=j.outerHeight();var l=$("#btnSendMessage"),m=$("#textArea"),n=$("#msgContainer");if(window.addEventListener("scroll",function(){const a=window.pageYOffset||document.documentElement.scrollTop,b=a-h;i+=-b,i=i<-k?-k:62<i?62:i,j.attr("style",`top: ${i}px !important;`),h=a},!1),0<window.messages.length){for(var o of window.messages)d(o);$("html, body").scrollTop($(document).height())}m.on("input",function(){const a=e();l.attr("disabled",!a)}),m.on("keydown",function(a){13===a.keyCode&&a.preventDefault()}),m.on("keyup",function(a){13===a.keyCode&&(a.preventDefault(),f())}),l.on("click",function(){f()}),g(),$(window).scroll(function(){isOnBottom=$(window).scrollTop()+$(window).height()==$(document).height()})});