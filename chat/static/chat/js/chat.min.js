class MessageHandler{constructor(a,b){this.GET_NEW_MESSAGES_TIMER=2,this.isMobile=window.isMobile(),this.msgContainer=$("#msgContainer"),this.btnSend=$("#btnSendMessage"),this.textArea=$("#textArea"),this.btnGoToBottom=$(".btn-go-to-bottom"),this.isOnBottom=!1,this.getMessagesApi=a,this.sendMessageApi=b,this.lastAppendedSenderId=void 0;var c=this;c.isOnBottom=!1,c.handleBottom=c.handleBottom.bind(c),$(window).scroll(c.handleBottom),$(window).on("resize",c.handleBottom),this.btnGoToBottom.on("click",function(){$("html, body").animate({scrollTop:$(document).height()})}),this.textArea.on("input",function(){const a=c.getValue();c.btnSend.attr("disabled",!a)}),this.textArea.on("keydown",function(a){13===a.keyCode&&a.preventDefault()}),this.textArea.on("keyup",function(a){13===a.keyCode&&(a.preventDefault(),c.sendMessage())}),this.btnSend.on("click",function(){c.sendMessage()}),this.appendExistingMessages(),this.getNewMessages=this.getNewMessages.bind(this),this.msgTimerId=setInterval(c.getNewMessages,1e3*this.GET_NEW_MESSAGES_TIMER)}handleBottom(){const a=this,b=Math.ceil(window.scrollY)-70;a.isOnBottom=window.innerHeight+b>=document.body.offsetHeight;const c=document.body.offsetHeight-(window.innerHeight+b);c<window.innerHeight/2?(a.btnGoToBottom.removeClass("show"),a.btnGoToBottom.addClass("hide"),$("#hasNewMessages").hide()):(a.btnGoToBottom.removeClass("hide"),a.btnGoToBottom.addClass("show"))}getValue(){return this.textArea.val()}getAvatar(a){let b=a?.sender?a?.sender.id:-1;return this.lastAppendedSenderId==b?"<div style=\"width:32px; height:32px; min-width: 32px !important; min-height: 32px;\"></div>":a?.sender?a.is_out&&this.isMobile?"":a?.sender?.avatar_sm?`
                <img
                    height="32"
                    width="32"
                    src="${a.sender.avatar_sm}" 
                    class="rounded-circle of-cover align-self-end"
                    alt 
                />
            `:"<div style=\"width:32px; height:32px; min-width: 32px !important; min-height: 32px;\"></div>":`
                <img
                    height="32"
                    width="32"
                    src="${window.sbImg}" 
                    class="rounded-circle align-self-end of-cover"
                    alt 
                />
            `}formatSentAt(a){return`${("0"+a.getDate()).slice(-2)}.${("0"+(a.getMonth()+1)).slice(-2)}.${a.getFullYear()}, ${("0"+a.getHours()).slice(-2)}:${("0"+a.getMinutes()).slice(-2)}`}getMessageHtml(a){const b=a.is_out?"bg-primary border-primary text-white":"bg-white border";var c="align-self-start";this.isMobile&&(c=a.is_out?"align-self-end":"align-self-start");const d=a.sender?"":"\u0421\u0438\u0441\u0442\u0435\u043C\u043D\u043E\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435 - ";var e=a.text;return a.sender&&(e=$("<div/>").text(e).html(),e=e.replaceAll("\n","<br>")),`
            <div class="list-group-item border-0 ${c} bg-sb-primary" style="width: fit-content;">
                <div class="d-flex gap-3">
                    `+this.getAvatar(a)+`
                    <div class="${b} rounded-4 box-shadow border-0">
                        <div class="p-1 px-2" style="font-size: 18px; height: fit-content">${e}</div>
                        <small class="float-end pe-1 align-self-end ps-3 mt-2 me-1" style="font-size: 11px;">${d}${this.formatSentAt(new Date(a.sent_at))}</small>
                    </div>  
                </div>
            </div>  
        `}appendMessage(a){this.msgContainer.append(this.getMessageHtml(a)),this.lastAppendedSenderId=a?.sender?a?.sender?.id:-1}appendExistingMessages(){if(0<window?.messages.length){for(var a of window.messages)this.appendMessage(a);$("html, body").scrollTop($(document).height())}}sendMessage(){function a(a){d.textArea.val(null);for(let b of a.data)d.appendMessage(b);$("html, body").animate({scrollTop:$(document).height()}),d.msgTimerId=setInterval(d.getNewMessages,1e3*d.GET_NEW_MESSAGES_TIMER)}function b(a){showErrorToast(a.responseJSON.message),d.btnSend.attr("disabled",!1)}const c=this.getValue();if(c){const e=new FormData;e.append("text",c);var d=this;d.btnSend.attr("disabled",!0),clearInterval(d.msgTimerId),d.textArea.focus(),$.ajax({type:"POST",url:d.sendMessageApi,data:e,processData:!1,contentType:!1,success:a,error:b})}}getNewMessages(){var a=this;$.ajax({type:"GET",url:a.getMessagesApi,success:function(b){if(0<b?.data?.length){for(let c of b.data)a.appendMessage(c);a.isOnBottom?$("html, body").animate({scrollTop:$(document).height()}):$("#hasNewMessages").show()}}})}}