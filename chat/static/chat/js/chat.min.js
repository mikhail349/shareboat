class MessageHandler{constructor(a,b){this.msgContainer=$("#msgContainer"),this.btnSend=$("#btnSendMessage"),this.textArea=$("#textArea"),this.isOnBottom=!1,this.longPollingApi=a,this.sendMessageApi=b;var c=this;$(window).scroll(function(){c.isOnBottom=$(window).scrollTop()+$(window).height()==$(document).height()}),this.textArea.on("input",function(){const a=c.getValue();c.btnSend.attr("disabled",!a)}),this.textArea.on("keydown",function(a){13===a.keyCode&&a.preventDefault()}),this.textArea.on("keyup",function(a){13===a.keyCode&&(a.preventDefault(),c.sendMessage())}),this.btnSend.on("click",function(){c.sendMessage()}),this.appendExistingMessages(),this.getNewMessages()}getValue(){return this.textArea.val()}getAvatar(a){return a?.sender?.avatar?`
                <img
                    height="32"
                    width="32"
                    src="${a.sender.avatar}" 
                    class="rounded-circle chat-avatar"
                    alt 
                />
            `:"<div style=\"width:32px; height:32px; min-width: 32px !important; min-height: 32px;\"></div>"}formatSentAt(a){return`${("0"+a.getDate()).slice(-2)}.${("0"+(a.getMonth()+1)).slice(-2)}.${a.getFullYear()}, ${("0"+a.getHours()).slice(-2)}:${("0"+a.getMinutes()).slice(-2)}`}getMessageHtml(a){const b=a.sender?a.is_out?"bg-primary text-white":"bg-secondary text-white":"bg-white text-dark border border-dark",c=a.sender?"":"\u0421\u0438\u0441\u0442\u0435\u043C\u043D\u043E\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435<br>";return`
            <div id="msg${a.id}" class="list-group-item border-0" style="width: fit-content;">
                <div class="d-flex gap-3">
                    `+this.getAvatar(a)+`
                    <div class="d-flex ${b} rounded p-1 px-2" style="font-size: 18px; height: fit-content">${a.text.replaceAll("\r\n","<br>")}</div>
                    <small class="float-end pe-1 align-self-end" style="font-size: 12px;">${c}${this.formatSentAt(new Date(a.sent_at))}</small>
                </div>
            </div>  
        `}appendMessage(a){this.msgContainer.append(this.getMessageHtml(a))}appendExistingMessages(){if(0<window?.messages.length){for(var a of window.messages)this.appendMessage(a);$("html, body").scrollTop($(document).height())}}sendMessage(){function a(a){d.textArea.val(null),d.appendMessage(a.data),$("html, body").animate({scrollTop:$(document).height()})}function b(a){showErrorToast(a.responseJSON.message)}const c=this.getValue();if(c){const e=new FormData;e.append("text",c);var d=this;$.ajax({type:"POST",url:d.sendMessageApi,data:e,processData:!1,contentType:!1,success:a,error:b})}}// Long polling
getNewMessages(){var a=this;$.ajax({type:"GET",url:this.longPollingApi}).done(function(b){if(0<b?.data?.length){for(let c of b.data)a.appendMessage(c);a.isOnBottom&&$("html, body").animate({scrollTop:$(document).height()})}a.getNewMessages()}).fail(function(b){0==b.status&&a.getNewMessages()})}}